<odoo>
  <!-- Remove old broad company rules if they exist -->
  <delete id="mc_rule_request_company" model="ir.rule"/>
  <delete id="mc_rule_rule_company" model="ir.rule"/>
  <delete id="mc_rule_line_company" model="ir.rule"/>

  <!-- REQUESTS (READ): requester OR any approver. READ-ONLY. -->
  <record id="rule_kh_request_read_own_or_approver" model="ir.rule">
    <field name="name">Requests: Read Own or as Approver</field>
    <field name="model_id" ref="model_kh_approval_request"/>
    <field name="domain_force">
      [
        '|',
        ('requester_id', '=', user.id),
        '&amp;', ('id', '!=', False), # This forces correct evaluation
        ('approval_line_ids.approver_id', '=', user.id)
      ]
    </field>
    <field name="groups" eval="[(4, ref('base.group_user'))]"/>
    <field name="perm_read" eval="1"/>
    <field name="perm_write" eval="0"/>
    <field name="perm_create" eval="0"/>
    <field name="perm_unlink" eval="0"/>
  </record>

  <!-- REQUESTS (WRITE/CREATE): Requester can create, and can edit their own DRAFT requests. -->
  <record id="rule_kh_request_write_own_draft" model="ir.rule">
    <field name="name">Requests: Write/Create Own Drafts</field>
    <field name="model_id" ref="model_kh_approval_request"/>
    <field name="domain_force">[('requester_id.id', '=', user.id), ('state', '=', 'draft')]</field>
    <field name="groups" eval="[(4, ref('base.group_user'))]"/>
    <field name="perm_read" eval="0"/>
    <field name="perm_write" eval="1"/>
    <field name="perm_create" eval="1"/>
    <field name="perm_unlink" eval="0"/>
  </record>

  <!-- REQUESTS: managers see all -->
  <record id="rule_kh_request_manager_all" model="ir.rule">
    <field name="name">Requests: Manager All</field>
    <field name="model_id" ref="model_kh_approval_request"/>
    <field name="domain_force">[(1,'=',1)]</field>
    <field name="groups" eval="[(4, ref('kh_approvals.group_kh_approvals_manager'))]"/>
    <field name="perm_read" eval="1"/>
    <field name="perm_write" eval="1"/>
    <field name="perm_create" eval="1"/>
    <field name="perm_unlink" eval="1"/>
  </record>

  <!-- LINES: all steps of any request I own OR I am approver on -->
  <record id="rule_kh_line_own_or_approver" model="ir.rule">
    <field name="name">Lines: All steps for my readable requests</field>
    <field name="model_id" ref="model_kh_approval_line"/>
    <!-- A user can see a line if they are the approver on THAT line, or if they are the requester of the parent request -->
    <field name="domain_force">
      ['|',
        ('approver_id', '=', user.id),
        ('request_id.requester_id', '=', user.id)
      ]
    </field>
    <field name="groups" eval="[(4, ref('base.group_user'))]"/>
    <field name="perm_read" eval="1"/>
    <field name="perm_write" eval="0"/>
    <field name="perm_create" eval="0"/>
    <field name="perm_unlink" eval="0"/>
  </record>

  <!-- LINES: managers see all -->
  <record id="rule_kh_line_manager_all" model="ir.rule">
    <field name="name">Lines: Manager All</field>
    <field name="model_id" ref="model_kh_approval_line"/>
    <field name="domain_force">[(1,'=',1)]</field>
    <field name="groups" eval="[(4, ref('kh_approvals.group_kh_approvals_manager'))]"/>
    <field name="perm_read" eval="1"/>
    <field name="perm_write" eval="1"/>
    <field name="perm_create" eval="1"/>
    <field name="perm_unlink" eval="1"/>
  </record>
</odoo>
