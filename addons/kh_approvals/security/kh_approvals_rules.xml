<odoo>
  <!-- Remove old broad company rules if they exist -->
  <delete id="mc_rule_request_company" model="ir.rule"/>
  <delete id="mc_rule_rule_company" model="ir.rule"/>
  <delete id="mc_rule_line_company" model="ir.rule"/>

  <!-- RULE 1 (USER): Can read their OWN requests. -->
  <record id="rule_kh_request_read_own" model="ir.rule">
    <field name="name">Requests: Read Own</field>
    <field name="model_id" ref="model_kh_approval_request"/>
    <field name="domain_force">[('requester_id', '=', user.id)]</field>
    <field name="groups" eval="[(4, ref('base.group_user'))]"/>
    <field name="perm_read" eval="1"/>
    <field name="perm_write" eval="0"/>
    <field name="perm_create" eval="0"/>
    <field name="perm_unlink" eval="0"/>
  </record>

  <!-- RULE 2 (USER): Can read requests where they are an approver. -->
  <record id="rule_kh_request_read_as_approver" model="ir.rule">
    <field name="name">Requests: Read as Approver</field>
    <field name="model_id" ref="model_kh_approval_request"/>
    <!-- This domain finds all requests that have a line where the current user is the approver.
         It is evaluated correctly because it's in its own rule. -->
    <field name="domain_force">[('approval_line_ids.approver_id', '=', user.id)]</field>
    <field name="groups" eval="[(4, ref('base.group_user'))]"/>
    <field name="perm_read" eval="1"/>
    <field name="perm_write" eval="0"/>
    <field name="perm_create" eval="0"/>
    <field name="perm_unlink" eval="0"/>
  </record>

  <!-- RULE 3 (USER): Can create, and can edit their own DRAFT requests. -->
  <record id="rule_kh_request_write_own_draft" model="ir.rule">
    <field name="name">Requests: Write/Create Own Drafts</field>
    <field name="model_id" ref="model_kh_approval_request"/>
    <field name="domain_force">[('requester_id.id', '=', user.id), ('state', '=', 'draft')]</field>
    <field name="groups" eval="[(4, ref('base.group_user'))]"/>
    <field name="perm_read" eval="0"/>
    <field name="perm_write" eval="1"/>
    <field name="perm_create" eval="1"/>
    <field name="perm_unlink" eval="0"/>
  </record>

  <!-- RULE 4 (USER): Can write on their own non-draft requests (to allow 'Revise'). -->
  <record id="rule_kh_request_write_own_submitted" model="ir.rule">
    <field name="name">Requests: Write Own Submitted</field>
    <field name="model_id" ref="model_kh_approval_request"/>
    <field name="domain_force">[('requester_id', '=', user.id), ('state', 'in', ['in_review', 'approved', 'rejected'])]</field>
    <field name="groups" eval="[(4, ref('base.group_user'))]"/>
    <field name="perm_read" eval="0"/>
    <field name="perm_write" eval="1"/>
    <field name="perm_create" eval="0"/>
    <field name="perm_unlink" eval="0"/>
  </record>

  <!-- RULE 5 (USER): Approver can write on a request they are pending on (to approve/reject). -->
  <record id="rule_kh_request_write_as_approver" model="ir.rule">
    <field name="name">Requests: Write as current approver</field>
    <field name="model_id" ref="model_kh_approval_request"/>
    <field name="domain_force">[('state', '=', 'in_review'), ('approval_line_ids.approver_id', '=', user.id), ('approval_line_ids.state', '=', 'pending')]</field>
    <field name="groups" eval="[(4, ref('base.group_user'))]"/>
    <field name="perm_read" eval="0"/>
    <field name="perm_write" eval="1"/>
    <field name="perm_create" eval="0"/>
    <field name="perm_unlink" eval="0"/>
  </record>

  <!-- RULE 6 (ACCOUNTANT): Can read approved requests with an amount. -->
  <record id="rule_kh_request_read_as_accountant" model="ir.rule">
    <field name="name">Requests: Read as Accountant for Payment</field>
    <field name="model_id" ref="model_kh_approval_request"/>
    <field name="domain_force">[('state', '=', 'approved'), ('amount', '>', 0)]</field>
    <field name="groups" eval="[(4, ref('kh_approvals.group_kh_approvals_accountant'))]"/>
    <field name="perm_read" eval="1"/>
    <field name="perm_write" eval="0"/>
    <field name="perm_create" eval="0"/>
    <field name="perm_unlink" eval="0"/>
  </record>


  <!-- REQUESTS: managers see all -->
  <record id="rule_kh_request_manager_all" model="ir.rule">
    <field name="name">Requests: Manager All</field>
    <field name="model_id" ref="model_kh_approval_request"/>
    <field name="domain_force">[(1,'=',1)]</field>
    <field name="groups" eval="[(4, ref('kh_approvals.group_kh_approvals_manager'))]"/>
    <field name="perm_read" eval="1"/>
    <field name="perm_write" eval="1"/>
    <field name="perm_create" eval="1"/>
    <field name="perm_unlink" eval="1"/>
  </record>

  <!-- LINES: all steps of any request I own OR I am approver on -->
  <record id="rule_kh_line_own_or_approver" model="ir.rule">
    <field name="name">Lines: All steps for my readable requests</field>
    <field name="model_id" ref="model_kh_approval_line"/>
    <!-- A user can see a line if they are the approver on THAT line, or if they are the requester of the parent request -->
    <field name="domain_force">
      ['|',
        ('approver_id', '=', user.id),
        ('request_id.requester_id', '=', user.id)
      ]
    </field>
    <field name="groups" eval="[(4, ref('base.group_user'))]"/>
    <field name="perm_read" eval="1"/>
    <field name="perm_write" eval="0"/>
    <field name="perm_create" eval="0"/>
    <field name="perm_unlink" eval="0"/>
  </record>

  <!-- LINES: managers see all -->
  <record id="rule_kh_line_manager_all" model="ir.rule">
    <field name="name">Lines: Manager All</field>
    <field name="model_id" ref="model_kh_approval_line"/>
    <field name="domain_force">[(1,'=',1)]</field>
    <field name="groups" eval="[(4, ref('kh_approvals.group_kh_approvals_manager'))]"/>
    <field name="perm_read" eval="1"/>
    <field name="perm_write" eval="1"/>
    <field name="perm_create" eval="1"/>
    <field name="perm_unlink" eval="1"/>
  </record>
</odoo>